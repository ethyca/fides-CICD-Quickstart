name: CI

on:
  push:
    branches:
    - main
  pull_request:

jobs:
  fides_checks:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: sample_db
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: python -m pip install psycopg2-binary ethyca-fides
      - name: Run database migrations
        run: |
          python -c "
          import os
          import psycopg2
          from psycopg2 import sql

          DB_HOST = 'localhost'
          DB_PORT = 5432
          DB_USER = 'postgres'
          DB_PASSWORD = 'postgres'
          DB_NAME = 'sample_db'

          conn = psycopg2.connect(
              dbname=DB_NAME,
              user=DB_USER,
              password=DB_PASSWORD,
              host=DB_HOST,
              port=DB_PORT
          )

          with open('database/migrations/postgres_sample.sql', 'r') as f:
              sql_script = f.read()

          with conn.cursor() as cursor:
              cursor.execute(sql_script)
              conn.commit()

          conn.close()
          "
      - name: Scan Database and validate that all fields are accounted for
        run: fides scan dataset db postgres://postgres:postgres@localhost:5432/sample_db
      - name: Evaluation
        run: fides evaluate .fides/
